<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIA-PY | Sistema de Apostilla Electrónica</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap 5 JS Bundle (necesario para las pestañas) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            /* COLORES ACTUALIZADOS SEGÚN REFERENCIA */
            --mre-blue: #002855;
            --mre-blue-light: #0038A8;
            --mre-red: #D52B1E;
            --mre-green: #10B981;
            --soft-bg: #f0f4f8; /* Color de fondo actualizado */
            --border-color: #E2E8F0;
            --input-bg: #F8FAFC;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 40, 85, 0.05); /* Sombra actualizada */
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Accesibilidad */
            --font-scale: 1;
            --base-font-size: 16px;
        }

        /* ESCALADO DINÁMICO */
        html {
            font-size: calc(var(--base-font-size) * var(--font-scale));
        }

        /* --- MODO ALTO CONTRASTE --- */
        body.high-contrast {
            --mre-blue: #000000;
            --mre-blue-light: #000000;
            --mre-red: #D50000;
            --soft-bg: #FFFFFF;
            --border-color: #000000;
            --input-bg: #FFFFFF;
            --text-main: #000000;
            --text-muted: #000000;
            --card-shadow: none;
        }
        body.high-contrast .elegant-background,
        body.high-contrast .bg-pattern { display: none; }
        body.high-contrast .btn-main { background: #000; border: 2px solid #000; }
        body.high-contrast .grid-frame { border: 2px solid #000; }

        /* --- MODO ESCALA DE GRISES --- */
        body.grayscale-mode {
            filter: grayscale(100%);
        }

        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            background-color: var(--soft-bg); 
            color: #1E293B; 
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            text-align: left; /* Alineación actualizada */
        }

        .hidden { display: none !important; }

        /* --- EFECTOS DE FONDO ACTUALIZADOS --- */
        .elegant-background { 
            position: fixed; 
            inset: 0; 
            z-index: -1; 
            background-color: #f8fafc; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(0, 56, 168, 0.08) 0px, transparent 50%), 
                radial-gradient(at 100% 0%, rgba(213, 43, 30, 0.05) 0px, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(0, 40, 85, 0.06) 0px, transparent 50%),
                radial-gradient(at 50% 50%, rgba(255, 255, 255, 0.8) 0px, transparent 100%); /* Capa extra de brillo */
        }
        
        .bg-pattern { 
            position: fixed; 
            inset: 0; 
            z-index: -1; 
            opacity: 0.5; /* Opacidad actualizada */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23002855' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E"); 
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade { animation: fadeIn 0.4s ease-out forwards; }

        /* --- CABECERA --- */
        #portalSection { padding: 1rem 3%; max-width: 1400px; margin: 0 auto; flex: 1; width: 100%; }
        .portal-header { 
            display: flex; justify-content: space-between; align-items: center; background: white; 
            padding: 0.75rem 1.5rem; border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); margin-bottom: 1rem; 
            border: 1px solid var(--border-color);
            position: relative;
            z-index: 1100;
        }

        /* --- ESTILOS DE CAMPOS Y FORMULARIOS (EXTRAIDOS) --- */
        .form-label { 
            font-size: 0.7rem !important; 
            font-weight: 800 !important; 
            text-transform: uppercase !important; 
            color: #64748B !important; 
            margin-bottom: 0.3rem; 
            display: block; 
            letter-spacing: 0.8px !important; 
        }
        
        .form-control-mre {
            background-color: var(--input-bg); 
            border: 1px solid #E2E8F0; 
            border-radius: 14px; /* Redondeado actualizado */
            padding: 0.8rem 1rem; /* Padding actualizado (ajustado a 1rem left para compatibilidad sin icono) */
            font-size: 0.85rem; 
            width: 100%; 
            transition: all 0.25s ease; 
            color: var(--mre-blue); 
            font-weight: 500;
        }
        
        .form-control-mre:focus { 
            background-color: #ffffff; 
            border-color: var(--mre-blue-light); 
            box-shadow: 0 0 0 4px rgba(0, 56, 168, 0.08); 
            outline: none; 
        }
        
        .form-control-mre:disabled, .form-control-mre[readonly] { 
            background-color: #f1f5f9; 
            color: #94a3b8; 
            cursor: not-allowed; 
        }

        /* --- ACCESIBILIDAD --- */
        .a11y-container { position: relative; margin-right: 15px; }
        
        .btn-a11y-trigger {
            background: #F8FAFC; border: 1px solid var(--border-color); color: var(--mre-blue);
            border-radius: 12px; padding: 0.5rem 0.8rem; font-weight: 700; font-size: 0.75rem;
            display: flex; align-items: center; gap: 6px; transition: var(--transition);
            text-transform: none; 
            letter-spacing: 0.5px;
        }
        .btn-a11y-trigger:hover, .btn-a11y-trigger.active {
            background: #F1F5F9; border-color: var(--mre-blue-light); color: var(--mre-blue-light);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .a11y-dropdown-menu {
            position: absolute; top: calc(100% + 10px); right: 0; 
            background: white; border-radius: 16px; width: 280px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.15); border: 1px solid var(--border-color);
            display: none; z-index: 3000; overflow: hidden; animation: fadeIn 0.2s ease-out;
            padding: 1rem;
        }
        .a11y-dropdown-menu.show { display: block; }

        .a11y-section-title {
            font-size: 0.65rem; font-weight: 800; text-transform: uppercase; color: #94A3B8;
            margin-bottom: 0.8rem; letter-spacing: 0.5px;
        }

        .text-resize-controls {
            display: flex; justify-content: space-between; align-items: center;
            background: #F8FAFC; border-radius: 10px; padding: 4px; border: 1px solid #E2E8F0;
            margin-bottom: 1rem;
        }
        .btn-resize {
            width: 32px; height: 32px; border: none; background: white; border-radius: 8px;
            color: var(--mre-blue); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: var(--transition);
        }
        .btn-resize:hover { background: var(--mre-blue); color: white; }
        .font-size-display { font-size: 0.85rem; font-weight: 700; color: #475569; }

        .switch-control {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.6rem 0; border-bottom: 1px solid #F1F5F9;
        }
        .switch-control:last-child { border-bottom: none; }
        .switch-label { font-size: 0.8rem; font-weight: 600; color: #1E293B; display: flex; align-items: center; gap: 8px; }
        
        .toggle-switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--mre-blue); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* --- PERFIL --- */
        .header-profile-trigger {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid transparent;
        }
        .header-profile-trigger:hover {
            background: #F8FAFC;
            border-color: var(--border-color);
        }

        .user-dropdown { position: relative; display: flex; align-items: center; }
        .dropdown-menu-mre { 
            position: absolute; top: 120%; right: 0; background: white; border-radius: 14px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color); 
            width: 240px; display: none; z-index: 1000; overflow: hidden;
            animation: fadeIn 0.2s ease-out;
        }
        .dropdown-menu-mre.show { display: block; }
        
        .dropdown-header-info {
            padding: 16px;
            background: #F8FAFC;
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-item-mre {
            padding: 12px 16px; border: none; background: none; width: 100%; text-align: left;
            font-size: 0.85rem; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 12px;
            transition: var(--transition);
        }
        .dropdown-item-mre:hover { background: #F1F5F9; color: var(--mre-blue); }
        .dropdown-item-mre i { width: 16px; color: #64748B; }
        .dropdown-item-mre:hover i { color: var(--mre-blue); }
        .dropdown-item-mre.text-danger:hover { background: #FFF1F2; color: #BE123C; }

        .action-divider { border-bottom: 2px solid #E2E8F0; margin: 1.5rem 0 1rem 0; display: flex; align-items: center; }
        .action-label { background: #E2E8F0; color: var(--mre-blue); font-size: 0.65rem; font-weight: 800; padding: 2px 10px; border-radius: 4px 4px 0 0; text-transform: uppercase; }

        /* --- BOTONES DE ESTADO --- */
        .status-container { display: flex; gap: 0.65rem; margin-bottom: 1.25rem; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .status-btn { 
            background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 0.75rem 1rem; 
            flex: 1; display: flex; align-items: center; justify-content: space-between; transition: var(--transition); 
            cursor: pointer; min-width: 170px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .status-btn:hover { transform: translateY(-2px); border-color: #CBD5E1; }
        .status-btn.active { border: 2px solid var(--mre-blue); background: #f0f7ff; }

        /* --- GRILLA --- */
        .grid-frame { 
            background: white; 
            border-radius: 20px; /* Podría ser 24px según estilo nuevo, pero mantenemos 20px o subimos un poco */
            padding: 0; box-shadow: var(--card-shadow); border: 1px solid #E2E8F0; position: relative; overflow: hidden; 
        }
        .grid-frame::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(to right, var(--mre-red), var(--mre-blue)); }
        .grid-header-frame { background-color: #F1F5F9; padding: 1rem 1.5rem; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between; align-items: center; }

        .mre-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .mre-table th { font-size: 0.65rem; font-weight: 800; color: #64748B; text-transform: uppercase; padding: 0.85rem 1.5rem; border-bottom: 2px solid #E2E8F0; white-space: nowrap; }
        .mre-table td { padding: 0.85rem 1.5rem; font-size: 0.8rem; border-bottom: 1px solid #F1F5F9; vertical-align: middle; }

        /* --- NUEVA PAGINACIÓN (COPIADA) --- */
        .grid-footer {
            padding: 1rem 1.5rem;
            background-color: #F8FAFC;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-pagination {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            background: white; border: 1px solid #E2E8F0; border-radius: 8px;
            color: #64748B; cursor: pointer; transition: var(--transition);
        }
        .btn-pagination:hover:not(:disabled) {
            background: var(--mre-blue); color: white; border-color: var(--mre-blue);
        }
        .btn-pagination:disabled {
            opacity: 0.5; cursor: not-allowed; background: #F1F5F9;
        }
        
        .page-indicator {
            font-size: 0.85rem; font-weight: 700; color: var(--mre-blue); padding: 0 8px;
        }

        /* --- BOTONES ACTUALIZADOS --- */
        .btn-main { 
            background: linear-gradient(135deg, var(--mre-blue) 0%, var(--mre-blue-light) 100%); 
            color: #ffffff; border: none; 
            border-radius: 14px; /* Radio actualizado */
            padding: 0.95rem; /* Padding actualizado */
            font-weight: 800; 
            font-size: 0.85rem; text-transform: uppercase; 
            letter-spacing: 1.2px; /* Spacing actualizado */
            box-shadow: 0 10px 15px -3px rgba(0, 40, 85, 0.15); /* Sombra actualizada */
            transition: var(--transition); 
        }

        /* --- HERRAMIENTAS --- */
        .btn-tool-generic {
            background: #FFFFFF;
            color: var(--mre-blue);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
            cursor: pointer;
            margin-right: 8px;
        }
        .btn-tool-generic:hover {
            background: #F1F5F9;
            border-color: var(--mre-blue);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* --- COLUMNAS --- */
        .cols-dropdown-container { position: relative; display: inline-block; }
        .cols-dropdown-menu {
            position: absolute; top: 120%; left: 0; background: white; border-radius: 14px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color);
            width: 220px; display: none; z-index: 1000; overflow: hidden;
            animation: fadeIn 0.2s ease-out; padding: 10px 0;
        }
        .cols-dropdown-menu.show { display: block; }
        .col-toggle-item {
            padding: 8px 16px; display: flex; align-items: center; gap: 12px;
            cursor: pointer; transition: var(--transition);
        }
        .col-toggle-item:hover { background: #F8FAFC; }
        .col-toggle-item input { cursor: pointer; width: 16px; height: 16px; }
        .col-toggle-item label { cursor: pointer; font-size: 0.8rem; font-weight: 600; color: #475569; margin: 0; flex-grow: 1; }

        .badge-status { padding: 4px 8px; border-radius: 99px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
        .bg-analisis { background: #E0F2FE; color: #0369A1; }
        .bg-pagado { background: #D1FAE5; color: #065F46; }
        .bg-devuelto { background: #FEF3C7; color: #92400E; }

        /* --- ACCION BOTONES --- */
        .btn-ver-pago {
            background: var(--mre-green); color: white; border: none; 
            padding: 6px 14px; border-radius: 8px; font-size: 0.65rem; font-weight: 800; 
            text-transform: uppercase; transition: var(--transition);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }
        .btn-ver-pago:hover { background: #059669; transform: translateY(-1px); }

        .btn-ver-motivo {
            background: #FEE2E2; color: #B91C1C; border: 1px solid #FECACA;
            padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800;
            text-transform: uppercase; transition: var(--transition);
        }
        .btn-ver-motivo:hover { background: #FECACA; }

        .btn-ver-obs {
            background: #FEF3C7; color: #92400E; border: 1px solid #FDE68A;
            padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800;
            text-transform: uppercase; transition: var(--transition);
        }
        .btn-ver-obs:hover { background: #FDE68A; }

        .btn-revision {
            background: var(--mre-blue); color: white; border: none;
            padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800;
            text-transform: uppercase; transition: var(--transition);
        }
        .btn-revision:hover { background: var(--mre-blue-light); }

        .btn-completar {
            background: var(--mre-green); color: white; border: none;
            padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800;
            text-transform: uppercase; transition: var(--transition);
        }
        .btn-completar:hover { background: #059669; }

        /* --- LIQUIDACIÓN --- */
        .liquidar-footer {
            padding: 1.5rem 2rem; display: flex; justify-content: flex-end; align-items: center; background: #F8FAFC; border-top: 1px solid #E2E8F0;
        }
        .btn-liquidar-main {
            min-width: 320px; padding: 1rem 2rem; font-size: 1rem; font-weight: 800; letter-spacing: 0.5px; border-radius: 12px;
            background: var(--mre-blue); color: white; border: none; box-shadow: 0 4px 6px -1px rgba(0, 40, 85, 0.3); transition: var(--transition);
        }
        .btn-liquidar-main:hover:not(:disabled) { background: var(--mre-blue-light); transform: translateY(-2px); }

        /* --- SUMMARY VIEW STYLES --- */
        .summary-card {
            background: white; border-radius: 24px; box-shadow: var(--card-shadow); border: 1px solid #E2E8F0;
            overflow: hidden; max-width: 800px; margin: 2rem auto; position: relative;
        }
        .summary-header {
            background: linear-gradient(135deg, var(--mre-blue) 0%, var(--mre-blue-light) 100%);
            padding: 2.5rem; text-align: center; color: white;
        }
        .summary-content { padding: 2.5rem; }
        .summary-details-box {
            background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem;
        }
        .detail-row {
            display: flex; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px dashed #E2E8F0;
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-size: 0.8rem; font-weight: 700; color: #64748B; text-transform: uppercase; }
        .detail-value { font-size: 0.9rem; font-weight: 800; color: var(--mre-blue); }
        .summary-item {
            display: flex; justify-content: space-between; align-items: center; padding: 1rem;
            border-bottom: 1px solid #F1F5F9; transition: var(--transition);
        }
        .summary-item:hover { background: #F8FAFC; }
        .summary-total-box {
            background: white; border: 2px solid var(--mre-blue); border-radius: 16px; padding: 2rem;
            display: flex; justify-content: space-between; align-items: center;
        }

        .mre-popup-overlay { position: fixed; inset: 0; background: rgba(0, 40, 85, 0.4); backdrop-filter: blur(4px); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .mre-popup { background: white; border-radius: 20px; max-width: 500px; width: 100%; padding: 2rem; position: relative; }

        /* --- ESTILOS FOOTER --- */
        .mre-footer {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-top: 1px solid #E2E8F0;
            padding: 1.2rem 2.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            margin-top: auto;
        }
        .footer-left {
            font-size: 0.75rem;
            color: #64748B;
            font-weight: 600;
        }
        .footer-right .btn-help {
            background: white;
            border: 1px solid var(--mre-blue);
            color: var(--mre-blue);
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 800;
            text-decoration: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center; gap: 8px;
            transition: all 0.2s ease;
        }
        .footer-right .btn-help:hover {
            background: var(--mre-blue);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 40, 85, 0.15);
        }

        /* Nav Tabs Customization */
        .nav-tabs .nav-link {
            color: #64748B;
            border: 1px solid transparent;
            border-top-left-radius: .25rem;
            border-top-right-radius: .25rem;
        }
        .nav-tabs .nav-link.active {
            color: var(--mre-blue);
            border-color: #dee2e6 #dee2e6 #fff;
        }
        .nav-tabs .nav-link:hover {
            border-color: #e9ecef #e9ecef #dee2e6;
            color: var(--mre-blue);
        }

        /* --- RESPONSIVIDAD MEJORADA --- */
        @media (max-width: 768px) {
            .portal-header {
                padding: 0.75rem 1rem;
                flex-wrap: wrap; /* Permitir que los elementos bajen si es necesario */
                gap: 10px;
            }
            
            /* Ajustes en Grilla Principal */
            .grid-frame {
                padding: 1rem !important; /* Reducir padding en móvil */
                border-radius: 16px;
            }
            .grid-header-frame {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }
            .grid-header-frame > div {
                width: 100%;
                justify-content: flex-start !important;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            /* Herramientas de tabla en móvil */
            .cols-dropdown-container, 
            .btn-tool-generic, 
            .position-relative {
                flex: 1 1 auto; /* Crecer para llenar espacio */
            }
            .btn-tool-generic {
                justify-content: center;
                margin-right: 0;
            }
            .position-relative {
                max-width: 100% !important; /* Barra de búsqueda full width */
            }

            /* Botones Principales en Móvil */
            .btn-main {
                width: 100%;
                justify-content: center;
                padding: 1rem;
            }

            /* Popups */
            .mre-popup {
                width: 90%;
                padding: 1.5rem;
                max-height: 90vh;
                overflow-y: auto;
            }

            /* Footer */
            .mre-footer {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
                padding: 1.5rem;
            }

            /* Ajustes de Tablas para Móvil */
            .mre-table th, .mre-table td {
                padding: 0.75rem 1rem;
            }
            
            /* Pestañas */
            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }

            /* Formularios */
            .grid-frame form .row > div {
                margin-bottom: 0.5rem; /* Menos espacio vertical entre campos */
            }
            
            /* Botones de acción en formularios */
            .d-flex.justify-content-end.gap-3 {
                flex-direction: column-reverse;
                gap: 0.75rem !important;
            }
            .d-flex.justify-content-end.gap-3 button {
                width: 100%;
            }
        }

        /* --- NUEVO: CONTROLES DE SCROLL PARA BOTONES DE ESTADO --- */
        .status-scroll-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            margin-bottom: 1.25rem;
        }
        
        .status-container { 
            /* Sobrescribir margin-bottom original ya que el wrapper lo maneja */
            margin-bottom: 0; 
            scroll-behavior: smooth;
            /* Ocultar barra de scroll nativa para limpieza visual */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .status-container::-webkit-scrollbar {
            display: none;
        }

        .scroll-btn {
            background: white;
            border: 1px solid #E2E8F0;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: var(--mre-blue);
            transition: var(--transition);
            flex-shrink: 0;
        }
        .scroll-btn:hover {
            background: #F8FAFC;
            color: var(--mre-blue-light);
            border-color: var(--mre-blue-light);
            transform: scale(1.05);
        }
        .scroll-btn.left { margin-right: 8px; }
        .scroll-btn.right { margin-left: 8px; }

        /* Ocultar botones de scroll en pantallas muy grandes donde no son necesarios */
        @media (min-width: 1400px) {
            .scroll-btn { display: none; }
        }
    </style>
</head>
<body>

    <div class="elegant-background"></div>
    <div class="bg-pattern"></div>

    <div class="mre-popup-overlay" id="genericPopup">
        <div class="mre-popup animate-fade">
            <h5 class="fw-black text-navy mb-3" id="popupTitle">Información</h5>
            <div class="p-2 bg-light rounded-3 mb-4 border" id="popupContent"></div>
            <div id="popupActions">
                <button class="btn-main w-100" id="popupBtnEntendido" onclick="closePopup()">Entendido</button>
            </div>
        </div>
    </div>

    <section id="portalSection">
        <header class="portal-header animate-fade">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-white p-2 rounded-3 border" onclick="navigateTo('dashboard')" style="cursor:pointer">
                    <i data-lucide="globe" style="color: var(--mre-blue); width: 20px;"></i>
                </div>
                <div><h6 class="fw-black mb-0">SIA-PY</h6><p class="text-muted small mb-0 fw-bold uppercase" style="font-size: 0.55rem;">Apostilla Electrónica</p></div>
            </div>
            
            <div class="user-dropdown">
                <div class="a11y-container d-inline-block">
                    <button class="btn-a11y-trigger" id="a11yTrigger" onclick="toggleA11yMenu(event)" title="Opciones de Accesibilidad">
                        <i data-lucide="accessibility" style="width: 18px;"></i>
                        <span class="d-none d-md-inline">Accesibilidad</span>
                        <i data-lucide="chevron-down" style="width: 14px; margin-left: 4px;"></i>
                    </button>
                    
                    <div class="a11y-dropdown-menu" id="a11yMenu" onclick="event.stopPropagation()">
                        <div class="a11y-section-title">Tamaño de Texto</div>
                        <div class="text-resize-controls">
                            <button class="btn-resize" onclick="changeFontSize(-0.1)" title="Reducir"><i data-lucide="minus" style="width: 16px;"></i></button>
                            <span class="font-size-display" id="fontSizeDisplay">100%</span>
                            <button class="btn-resize" onclick="changeFontSize(0.1)" title="Aumentar"><i data-lucide="plus" style="width: 16px;"></i></button>
                        </div>
                        <div class="a11y-section-title mt-3">Visualización</div>
                        <div class="switch-control">
                            <div class="switch-label"><i data-lucide="eye-off" style="width: 16px;"></i> Escala de Grises</div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="switchGrayscale" onchange="toggleGrayscale()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="header-profile-trigger d-inline-flex" id="profileTrigger" onclick="toggleUserMenu(event)">
                    <div class="text-end d-none d-md-block">
                        <p class="small fw-black mb-0">JUAN ROMÁN PÉREZ</p>
                        <p class="text-muted mb-0" style="font-size: 0.6rem; font-weight: 700;">CI: 4.567.890</p>
                    </div>
                    <div class="bg-light border-0 shadow-sm rounded-circle p-2" style="width: 38px; height: 38px; display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="user" style="width:18px; color: var(--mre-blue);"></i>
                    </div>
                </div>
                <div class="dropdown-menu-mre" id="userMenu">
                    <div class="dropdown-header-info">
                        <p class="fw-black text-navy mb-0" style="font-size: 0.85rem;">Juan Román Pérez</p>
                        <p class="text-muted small mb-0 fw-bold">juan.perez@email.com</p>
                    </div>
                    <button class="dropdown-item-mre" onclick="navigateTo('profile')"><i data-lucide="user-cog"></i> Mi Perfil</button>
                    <button class="dropdown-item-mre text-danger" onclick="handleLogout()"><i data-lucide="log-out"></i> Cerrar Sesión</button>
                </div>
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="animate-fade">
            <div class="action-divider"><span class="action-label">Acciones Principales</span></div>
            <div class="mb-3">
                <button class="btn-main d-inline-flex align-items-center gap-2" onclick="navigateTo('newRequest')">
                    <i data-lucide="plus" style="width: 16px;"></i> Nueva Solicitud
                </button>
            </div>

            <div class="action-divider"><span class="action-label">Estados de Trámite</span></div>

            <!-- Wrapper con controles de navegación -->
            <div class="status-scroll-wrapper">
                <button class="scroll-btn left" onclick="scrollStatus('left')" aria-label="Anterior">
                    <i data-lucide="chevron-left" style="width:20px"></i>
                </button>
                
                <div class="status-container" id="statusScrollContainer">
                    <div class="status-btn" id="btnAnalisis" onclick="filterTable('Análisis', this)"><div class="d-flex align-items-center gap-2"><div class="status-icon-box bg-primary-subtle p-2 rounded-circle"><i data-lucide="clock" class="text-primary" style="width: 14px;"></i></div><div><span class="fw-bold text-navy">En Análisis</span></div></div><span class="fs-5 fw-black text-navy">02</span></div>
                    <div class="status-btn" id="btnAprobado" onclick="filterTable('Aprobado', this)"><div class="d-flex align-items-center gap-2"><div class="status-icon-box bg-success-subtle p-2 rounded-circle"><i data-lucide="check-circle" class="text-success" style="width: 14px;"></i></div><div><span class="fw-bold text-navy">Aprobados</span></div></div><span class="fs-5 fw-black text-success">02</span></div>
                    <div class="status-btn" id="btnDevuelto" onclick="filterTable('Devuelto', this)"><div class="d-flex align-items-center gap-2"><div class="status-icon-box bg-warning-subtle p-2 rounded-circle"><i data-lucide="rotate-ccw" class="text-warning" style="width: 14px;"></i></div><div><span class="fw-bold text-navy">Devueltos</span></div></div><span class="fs-5 fw-black text-warning">02</span></div>
                    <div class="status-btn" id="btnRechazado" onclick="filterTable('Rechazado', this)"><div class="d-flex align-items-center gap-2"><div class="status-icon-box bg-danger-subtle p-2 rounded-circle"><i data-lucide="x-circle" class="text-danger" style="width: 14px;"></i></div><div><span class="fw-bold text-navy">Rechazados</span></div></div><span class="fs-5 fw-black text-danger">02</span></div>
                    <!-- FINALIZADOS AHORA ES APOSTILLA -->
                    <div class="status-btn" id="btnFinalizado" onclick="filterTable('Finalizados', this)"><div class="d-flex align-items-center gap-2"><div class="status-icon-box bg-dark-subtle p-2 rounded-circle"><i data-lucide="file-badge" class="text-dark" style="width: 14px;"></i></div><div><span class="fw-bold text-navy">Apostilla</span></div></div><span class="fs-5 fw-black text-dark">02</span></div>
                </div>

                <button class="scroll-btn right" onclick="scrollStatus('right')" aria-label="Siguiente">
                    <i data-lucide="chevron-right" style="width:20px"></i>
                </button>
            </div>

            <div class="grid-frame animate-fade">
                <div class="grid-header-frame">
                    <h4 class="fw-black text-uppercase m-0" id="tableTitle" style="color: var(--mre-blue); font-size: 0.85rem;">Listado de Solicitudes</h4>
                    <div class="d-flex align-items-center" style="max-width: 600px; width: 100%; justify-content: flex-end;">
                        
                        <div class="cols-dropdown-container">
                            <button id="btnColumnas" class="btn-tool-generic" onclick="toggleColsMenu(event)" title="Configurar columnas visibles">
                                <i data-lucide="layout-columns" style="width: 16px;"></i> Columnas
                            </button>
                            <div class="cols-dropdown-menu" id="colsMenu" onclick="event.stopPropagation()"></div>
                        </div>

                        <button id="btnExportExcel" class="btn-tool-generic" onclick="exportToExcel()" title="Descargar listado en Excel (CSV)">
                            <i data-lucide="file-spreadsheet" style="width: 16px;"></i> Excel
                        </button>

                        <button id="btnExportPdf" class="btn-tool-generic" onclick="exportToPdf()" title="Descargar listado en PDF">
                            <i data-lucide="file-text" style="width: 16px;"></i> PDF
                        </button>
                        
                        <div class="position-relative" style="max-width: 250px; width: 100%;">
                            <i data-lucide="search" class="position-absolute" style="left: 10px; top: 50%; transform: translateY(-50%); width: 12px; color: #94A3B8;"></i>
                            <input type="text" class="form-control-mre w-100 ps-5" placeholder="Filtrar..." onkeyup="searchRequests(this)">
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="mre-table" id="requestsTable">
                        <thead id="tableHeader"></thead>
                        <tbody id="tableContent"></tbody>
                    </table>
                </div>

                <!-- NUEVA SECCIÓN DE PAGINACIÓN -->
                <div class="grid-footer">
                    <div class="d-flex align-items-center">
                        <span class="text-muted small fw-bold" id="paginationInfo">Mostrando 0 a 0 de 0 registros</span>
                    </div>

                    <div class="d-flex align-items-center gap-1">
                        <button class="btn-pagination" id="btnPageFirst" onclick="changePage('first')" title="Primera Página">
                            <i data-lucide="chevrons-left" style="width: 16px;"></i>
                        </button>
                        <button class="btn-pagination" id="btnPagePrev" onclick="changePage('prev')" title="Página Anterior">
                            <i data-lucide="chevron-left" style="width: 16px;"></i>
                        </button>
                        
                        <span class="page-indicator" id="pageIndicator">Pág 1</span>
                        
                        <button class="btn-pagination" id="btnPageNext" onclick="changePage('next')" title="Página Siguiente">
                            <i data-lucide="chevron-right" style="width: 16px;"></i>
                        </button>
                        <button class="btn-pagination" id="btnPageLast" onclick="changePage('last')" title="Última Página">
                            <i data-lucide="chevrons-right" style="width: 16px;"></i>
                        </button>
                    </div>
                </div>

                <div id="liquidadorSection" class="liquidar-footer hidden">
                    <button class="btn-liquidar-main" id="btnLiquidacion" disabled onclick="navigateTo('summary')">
                        Generar Liquidación (Gs. 0)
                    </button>
                </div>
            </div>
        </div>

        <!-- SUMMARY VIEW -->
        <div id="summaryView" class="hidden animate-fade">
            <div class="summary-card">
                <div class="summary-header">
                    <div class="bg-white d-inline-flex p-3 rounded-circle shadow-sm mb-3">
                        <i data-lucide="file-check" style="width: 48px; height: 48px; color: var(--mre-blue);"></i>
                    </div>
                    <h2 class="fw-black mb-0">Resumen de Liquidación</h2>
                    <p class="small fw-bold opacity-75">Verifique los trámites antes de proceder al pago</p>
                </div>
                <div class="summary-content">
                    <div class="summary-details-box">
                        <div class="detail-row">
                            <span class="detail-label">Fecha de solicitud:</span>
                            <span class="detail-value" id="summaryRequestDate">--/--/---- --:--:--</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Vencimiento:</span>
                            <span class="detail-value text-danger" id="summaryExpiryDate">--/--/---- --:--:--</span>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h6 class="fw-black text-navy small uppercase border-bottom pb-2 mb-3">Detalle de Aranceles</h6>
                        <div id="summaryItemsList"></div>
                    </div>
                    <div class="summary-total-box">
                        <div>
                            <p class="extra-small text-muted fw-bold uppercase mb-0">Total a abonar</p>
                            <h3 class="fw-black text-navy mb-0" id="summaryTotalValue">Gs. 0</h3>
                        </div>
                        <div class="d-flex gap-2">
                             <button class="btn btn-outline-primary fw-bold px-4 py-2 rounded-3" onclick="alert('Descargando liquidación...')">
                                <i data-lucide="download" style="width:16px; margin-right:5px"></i> Descargar
                             </button>
                             <button class="btn-main rounded-3 px-5" onclick="alert('Redirigiendo a pasarela de pago...')">
                                Proceder al Pago
                             </button>
                        </div>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-link text-muted fw-bold small text-decoration-none" onclick="navigateTo('dashboard')">
                            <i data-lucide="arrow-left" style="width:14px"></i> Volver para modificar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PROFILE VIEW -->
        <div id="profileView" class="hidden animate-fade">
            <div class="grid-frame p-4 p-md-5 mx-auto" style="max-width: 900px; margin-top: 2rem;">
                <div class="d-flex align-items-center justify-content-between mb-4 border-bottom pb-3">
                    <h4 class="fw-black text-navy m-0">Mi Perfil</h4>
                    <span class="badge bg-light text-dark border">Edición de Datos</span>
                </div>

                <form id="profileForm" onsubmit="event.preventDefault(); saveProfile();">
                    <div class="row g-4">
                        <!-- 1. TIPO DE DOCUMENTO -->
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Tipo de Documento</label>
                            <input type="text" class="form-control-mre bg-light text-muted" value="Cédula de Identidad" readonly>
                        </div>
                        
                        <!-- 2. NÚMERO DE DOCUMENTO -->
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Número de Documento</label>
                            <input type="text" class="form-control-mre bg-light text-muted" value="4.567.890" readonly>
                        </div>

                        <!-- 3. NOMBRES -->
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Nombres</label>
                            <input type="text" class="form-control-mre" id="profileName" value="JUAN ROMÁN">
                        </div>
                        
                        <!-- 4. APELLIDOS -->
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Apellidos</label>
                            <input type="text" class="form-control-mre" id="profileSurname" value="PÉREZ">
                        </div>

                        <!-- 5. NACIONALIDAD -->
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Nacionalidad</label>
                            <select class="form-control-mre" id="profileNationality">
                                <option value="PY" selected>Paraguaya</option>
                                <option value="AR">Argentina</option>
                                <option value="BR">Brasilera</option>
                                <option value="ES">Española</option>
                                <option value="US">Estadounidense</option>
                                <option value="OT">Otra</option>
                            </select>
                        </div>

                        <!-- 6. CELULAR -->
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Celular</label>
                            <input type="tel" class="form-control-mre" id="profilePhone" value="+595 981 123 456">
                        </div>

                        <!-- 7. CORREO ELECTRÓNICO -->
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Correo Electrónico</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0 border"><i data-lucide="mail" style="width:16px; color:#64748B"></i></span>
                                <input type="email" class="form-control-mre border-start-0 ps-2 bg-light text-muted" value="juan.perez@email.com" readonly style="border-top-left-radius: 0; border-bottom-left-radius: 0;">
                            </div>
                        </div>

                        <!-- 8. DIRECCIÓN PARTICULAR -->
                        <div class="col-md-6">
                            <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Dirección Particular</label>
                            <input type="text" class="form-control-mre" id="profileAddress" value="Av. Mariscal López 1234, Asunción">
                        </div>

                        <!-- 9. CONTRASEÑA (Formato Campo) -->
                        <div class="col-12">
                            <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Contraseña</label>
                            <div class="d-flex gap-3 align-items-center p-3 border rounded-3 bg-light">
                                <div class="flex-grow-1 text-muted small">
                                    <i data-lucide="lock" style="width:14px; margin-right:5px; margin-bottom:2px"></i> ************
                                </div>
                                <button type="button" class="btn btn-outline-primary fw-bold btn-sm bg-white" onclick="requestPasswordReset()">
                                    Cambiar Contraseña
                                </button>
                            </div>
                        </div>

                        <!-- BOTONES DE ACCIÓN -->
                        <div class="col-12 mt-4 d-flex justify-content-end gap-3 border-top pt-4">
                            <button type="button" class="btn btn-light border fw-bold px-4" onclick="navigateTo('dashboard')">Cancelar</button>
                            <button type="submit" class="btn-main px-5 shadow-sm">Guardar Cambios</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW REQUEST VIEW -->
        <div id="newRequestView" class="hidden animate-fade">
            <div class="grid-frame p-4 p-md-5 mx-auto" style="max-width: 900px; margin-top: 2rem;">
                
                <!-- CONTENEDOR DEL FORMULARIO (SE OCULTA AL AÑADIR) -->
                <div id="requestFormContainer">
                    <div class="d-flex align-items-center justify-content-between mb-4 border-bottom pb-3">
                        <h4 class="fw-black text-navy m-0">Crear Solicitud</h4>
                        <span class="badge bg-light text-dark border">Nuevo Trámite</span>
                    </div>

                    <!-- Cambiado addToGrid() por confirmAdd() para el paso de verificación -->
                    <form id="newRequestForm" onsubmit="event.preventDefault(); confirmAdd();">
                        <div class="row g-4">
                            <!-- 1. PAIS -->
                            <div class="col-md-6">
                                <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">País de Destino <span class="text-danger">*</span></label>
                                <select class="form-control-mre" id="reqCountry" required>
                                    <option value="" selected disabled>Seleccione...</option>
                                    <option value="Argentina">Argentina</option>
                                    <option value="Brasil">Brasil</option>
                                    <option value="España">España</option>
                                    <option value="Estados Unidos">Estados Unidos</option>
                                    <option value="Uruguay">Uruguay</option>
                                    <option value="Alemania">Alemania</option>
                                    <option value="Francia">Francia</option>
                                </select>
                            </div>

                            <!-- 2. INSTITUCION -->
                            <div class="col-md-6">
                                <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Institución Emisora <span class="text-danger">*</span></label>
                                <select class="form-control-mre" id="reqInstitution" required>
                                    <option value="" selected disabled>Seleccione...</option>
                                    <option value="REC">Registro del Estado Civil</option>
                                    <option value="MEC">Ministerio de Educación y Ciencias</option>
                                    <option value="CSJ">Corte Suprema de Justicia</option>
                                    <option value="UP">Universidad Privada</option>
                                    <option value="DNIT">Dirección Nacional de Ingresos Tributarios</option>
                                </select>
                            </div>

                            <!-- 3. TIPO DE TRAMITE -->
                            <div class="col-md-6">
                                <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Tipo de Trámite <span class="text-danger">*</span></label>
                                <select class="form-control-mre" id="reqType" required>
                                    <option value="" selected disabled>Seleccione...</option>
                                    <option value="Apostilla">Apostilla</option>
                                    <option value="Legalización">Legalización</option>
                                </select>
                            </div>

                            <!-- 4. TIPO DE FIRMA -->
                            <div class="col-md-6">
                                <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Tipo de Firma <span class="text-danger">*</span></label>
                                <select class="form-control-mre" id="reqSignature" onchange="handleSignatureChange()" required>
                                    <option value="" selected disabled>Seleccione...</option>
                                    <option value="Electrónica">Electrónica</option>
                                    <option value="Ológrafa">Ológrafa (Manuscrita)</option>
                                </select>
                            </div>

                            <!-- CAMPO ADJUNTO (CONDICIONAL) -->
                            <div class="col-md-12 hidden animate-fade" id="attachmentField">
                                <div class="p-3 bg-light border rounded-3 border-dashed" style="border-style: dashed !important; border-color: #cbd5e1 !important;">
                                    <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2 text-primary">
                                        <i data-lucide="paperclip" style="width:14px"></i> Adjuntar Documento (PDF) <span class="text-danger">*</span>
                                    </label>
                                    <input type="file" class="form-control-mre" id="reqFile" accept=".pdf">
                                    <small class="text-muted mt-1 d-block" style="font-size: 0.7rem;">El documento debe estar firmado digitalmente. Formato .pdf, Máx 5MB.</small>
                                </div>
                            </div>

                            <!-- 5. TIPO DE DOCUMENTO (DEPENDIENTE) -->
                            <div class="col-md-12">
                                <label class="form-label text-muted small fw-bold text-uppercase d-block mb-2">Tipo de Documento <span class="text-danger">*</span></label>
                                <select class="form-control-mre" id="reqDocType" onchange="handleDocTypeChange()" disabled required>
                                    <option value="" selected disabled>Seleccione primero el tipo de firma...</option>
                                    <option value="Certificado de Nacimiento">Certificado de Nacimiento</option>
                                    <option value="Certificado de Matrimonio">Certificado de Matrimonio</option>
                                    <option value="Certificado de Defunción">Certificado de Defunción</option>
                                    <option value="Antecedentes Policiales">Antecedentes Policiales</option>
                                    <option value="Certificado de Estudios">Certificado de Estudios</option>
                                    <option value="Título Universitario">Título Universitario</option>
                                </select>
                            </div>

                            <!-- PESTAÑAS DE DATOS ADICIONALES (OCULTO INICIALMENTE) -->
                            <div class="col-12 mt-4 hidden animate-fade" id="additionalDataTabs">
                                <ul class="nav nav-tabs mb-3" id="requestTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active fw-bold" id="titular-tab" data-bs-toggle="tab" data-bs-target="#titular" type="button" role="tab" aria-selected="true">Datos del Titular</button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link fw-bold" id="especificos-tab" data-bs-toggle="tab" data-bs-target="#especificos" type="button" role="tab" aria-selected="false">Datos Específicos</button>
                                    </li>
                                </ul>
                                <div class="tab-content p-3 border border-top-0 rounded-bottom bg-white shadow-sm" id="requestTabsContent">
                                    <!-- TAB 1: DATOS TITULAR -->
                                    <div class="tab-pane fade show active" id="titular" role="tabpanel" aria-labelledby="titular-tab">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label text-muted small fw-bold text-uppercase">Tipo de Documento <span class="text-danger">*</span></label>
                                                <select class="form-control-mre" id="titularDocType" required>
                                                    <option value="CI">Cédula de Identidad</option>
                                                    <option value="PAS">Pasaporte</option>
                                                    <option value="OTRO">Otro</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label text-muted small fw-bold text-uppercase">Número de Documento <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control-mre" id="titularDocNum" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label text-muted small fw-bold text-uppercase">Nombre del Titular <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control-mre" id="titularName" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label text-muted small fw-bold text-uppercase">Nro. de Certificado de Nacimiento <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control-mre" id="titularCertNum" required>
                                            </div>
                                            
                                            <!-- Botón Siguiente -->
                                            <div class="col-12 text-end mt-4">
                                                <button type="button" class="btn btn-outline-primary fw-bold px-4 rounded-3 btn-sm" onclick="showTab('especificos-tab')">
                                                    Siguiente <i data-lucide="arrow-right" class="ms-1" style="width:14px; margin-bottom: 2px;"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- TAB 2: DATOS ESPECIFICOS -->
                                    <div class="tab-pane fade" id="especificos" role="tabpanel" aria-labelledby="especificos-tab">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label text-muted small fw-bold text-uppercase">Número de Acta <span class="text-danger">*</span></label>
                                                <input type="text" class="form-control-mre" id="actaNum" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label text-muted small fw-bold text-uppercase">Año <span class="text-danger">*</span></label>
                                                <select class="form-control-mre" id="actaYear" required>
                                                    <!-- Se pobla vía JS -->
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label text-muted small fw-bold text-uppercase">Fecha de Expedición <span class="text-danger">*</span></label>
                                                <input type="date" class="form-control-mre" id="actaDate" required>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BOTONES -->
                            <div class="col-12 mt-4 d-flex justify-content-end gap-3 border-top pt-4">
                                <button type="button" class="btn btn-light border fw-bold px-4" onclick="navigateTo('dashboard')">Cancelar</button>
                                <button type="submit" class="btn-main px-5 shadow-sm d-flex align-items-center gap-2">
                                    <i data-lucide="plus-circle" style="width:16px;"></i> Añadir
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- NUEVA GRILLA DE DOCUMENTOS CARGADOS (SE MUESTRA SOLO AL AÑADIR) -->
                <div id="loadedDocsSection" class="mt-0 hidden animate-fade">
                    <div class="d-flex align-items-center justify-content-between mb-4 border-bottom pb-3">
                        <h5 class="fw-black text-navy m-0">Documentos Cargados</h5>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="mre-table" id="loadedDocsTable">
                            <thead>
                                <tr>
                                    <th>País</th>
                                    <th>Institución</th>
                                    <th>Tipo de Documento</th>
                                    <th>Validación</th>
                                    <th class="text-center">Validado</th>
                                    <th class="text-center">Archivo</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="loadedDocsBody">
                                <!-- Filas dinámicas -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                        <button class="btn btn-outline-primary fw-bold px-4 rounded-3" onclick="showRequestForm()">
                            <i data-lucide="plus" style="width:16px; margin-right: 5px;"></i> Agregar Nuevo Trámite
                        </button>
                        <button class="btn-main px-5 shadow" onclick="submitFinalRequest()">
                            Generar Solicitud <i data-lucide="check" style="width:16px; margin-left: 5px;"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- NEW: VALIDATION VIEW (RENAMED TO SOLICITUDES GENERADAS) -->
        <div id="validationView" class="hidden animate-fade">
            <div class="grid-frame p-4 p-md-5 mx-auto" style="max-width: 1100px; margin-top: 2rem;">
                <div class="d-flex align-items-center justify-content-between mb-4 border-bottom pb-3">
                    <h4 class="fw-black text-navy m-0">Solicitudes Generadas</h4>
                    <span class="badge bg-success-subtle text-success border border-success-subtle">Proceso Finalizado</span>
                </div>

                <div class="alert alert-light border d-flex align-items-center gap-3 mb-4 shadow-sm" role="alert">
                    <div class="bg-primary-subtle text-primary p-2 rounded-circle">
                        <i data-lucide="check-circle-2" style="width:24px; height:24px"></i>
                    </div>
                    <div class="small">
                        <strong>¡Solicitudes generadas correctamente!</strong><br>
                        A continuación se detallan los números de solicitud asignados. Proceda al pago de las solicitudes verificadas automáticamente.
                    </div>
                </div>

                <!-- CONTENEDOR DINÁMICO PARA LAS TABLAS DIVIDIDAS -->
                <div id="validationTablesContainer"></div>

                <!-- Resumen oculto ya que la info está en las tablas -->
                <div class="d-flex justify-content-between align-items-center bg-light p-3 rounded-3 border mt-4 hidden">
                    <div>
                        <small class="text-muted fw-bold uppercase d-block">Cantidad Total</small>
                        <span class="fw-black text-navy fs-5" id="validationCount">0</span>
                    </div>
                    <div>
                        <small class="text-muted fw-bold uppercase d-block text-end">Total Estimado</small>
                        <span class="fw-black text-primary fs-4" id="validationTotal">Gs. 0</span>
                    </div>
                </div>

                <div class="d-flex justify-content-center mt-5 pt-4 border-top">
                    <button type="button" class="btn btn-light border fw-bold px-5" onclick="resetAndGoHome()">
                        <i data-lucide="home" style="width:16px; margin-right: 5px;"></i> Volver al Inicio
                    </button>
                </div>
            </div>
        </div>

    </section>

    <!-- FOOTER INSTITUCIONAL -->
    <footer class="mre-footer">
        <div class="footer-left">
            &copy; 2026 Ministerio de Relaciones Exteriores - Dirección de Informática
        </div>
        <div class="footer-right">
            <a href="https://www.mre.gov.py/contactenos/" target="_blank" class="btn-help">
                <i data-lucide="help-circle" style="width: 18px; height: 18px;"></i>
                ¿Necesitas ayuda?
            </a>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => { 
            lucide.createIcons(); 
            initAccessibility();
            renderTable('Devuelto'); 
            populateYears();
        });

        // Configuración unificada de columnas para control de visibilidad
        let columnsConfig = [
            { id: 'id', label: 'Nro. de Solicitud', visible: true },
            { id: 'date', label: 'Fecha de Solicitud', visible: true },
            { id: 'type', label: 'Tipo', visible: true },
            { id: 'country', label: 'País', visible: true },
            { id: 'institution', label: 'Institución', visible: true },
            { id: 'doc', label: 'Documento', visible: true },
            { id: 'signatureType', label: 'Tipo de Firma', visible: true },
            { id: 'status', label: 'Estado', visible: true },
            { id: 'importe', label: 'Importe', visible: true }, 
            { id: 'download', label: 'Descargar', visible: true },
            { id: 'reason', label: 'Motivo', visible: true }, 
            { id: 'obs', label: 'Obs', visible: true }, 
            { id: 'action', label: 'Acción', visible: true },
            // NUEVAS COLUMNAS PARA APOSTILLA
            { id: 'adjunto', label: 'Adjunto', visible: true },
            { id: 'apostille_leg', label: 'Apostilla/Legalización', visible: true }
        ];

        function initColsMenu(status) {
            const menu = document.getElementById('colsMenu');
            let tabKeys = [];
            if (status === 'Análisis') {
                tabKeys = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'status', 'download'];
            } else if (status === 'Aprobado') {
                tabKeys = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'status', 'importe', 'download', 'action'];
            } else if (status === 'Rechazado') {
                tabKeys = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'download', 'reason', 'action'];
            } else if (status === 'Devuelto') {
                tabKeys = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'download', 'obs', 'action'];
            } else if (status === 'Finalizados') { // APOSTILLA TAB LOGIC
                tabKeys = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'adjunto', 'apostille_leg'];
            } else {
                tabKeys = ['id', 'doc', 'status', 'date'];
            }

            const filteredCols = columnsConfig.filter(c => tabKeys.includes(c.id));

            menu.innerHTML = filteredCols.map(c => `
                <div class="col-toggle-item" onclick="toggleColumn('${c.id}')">
                    <input type="checkbox" ${c.visible ? 'checked' : ''} id="chk_${c.id}" onchange="toggleColumn('${c.id}')">
                    <label for="chk_${c.id}">${c.label}</label>
                </div>
            `).join('');
        }

        function toggleColsMenu(e) {
            e.stopPropagation();
            document.getElementById('colsMenu').classList.toggle('show');
        }

        function toggleColumn(id) {
            const col = columnsConfig.find(c => c.id === id);
            if (col) {
                col.visible = !col.visible;
                const chk = document.getElementById(`chk_${id}`);
                if (chk) chk.checked = col.visible;
                renderTable(currentFilter, currentPage);
            }
        }

        function toggleA11yMenu(e) {
            e.stopPropagation();
            document.getElementById('a11yMenu').classList.toggle('show');
        }

        function initAccessibility() {
            const scale = localStorage.getItem('mre_font_scale') || 1;
            document.documentElement.style.setProperty('--font-scale', scale);
            updateFontSizeDisplay(scale);
        }

        function changeFontSize(delta) {
            let current = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--font-scale')) || 1;
            let newScale = Math.min(Math.max(current + delta, 0.8), 1.5); 
            document.documentElement.style.setProperty('--font-scale', newScale);
            localStorage.setItem('mre_font_scale', newScale);
            updateFontSizeDisplay(newScale);
        }

        function updateFontSizeDisplay(scale) {
            const display = document.getElementById('fontSizeDisplay');
            if (display) display.innerText = Math.round(scale * 100) + '%';
        }

        function toggleGrayscale() { document.body.classList.toggle('grayscale-mode'); }

        const mockRequests = [];
        
        // --- 1. REGISTROS PARA ANÁLISIS ---
        mockRequests.push({
            id: "202600001", date: "08/01/2026 09:15:30", type: "Apostilla", country: "España", 
            institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento", 
            signatureType: "Electrónica", status: "Análisis", hasAttachment: true, verPago: false, importe: 0
        });
        mockRequests.push({
            id: "202600002", date: "08/01/2026 10:20:45", type: "Legalización", country: "Argentina", 
            institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento", 
            signatureType: "Ológrafa", status: "Análisis", hasAttachment: false, verPago: false, importe: 0
        });

        // --- 2. REGISTROS PARA APROBADOS ---
        mockRequests.push({
            id: "202510001", date: "12/12/2025 15:00:00", type: "Apostilla", country: "España", 
            institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento", 
            signatureType: "Electrónica", status: "Aprobado", importe: 80000, hasAttachment: true, verPago: true
        });
        mockRequests.push({
            id: "202510002", date: "12/12/2025 16:30:00", type: "Legalización", country: "Argentina", 
            institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento", 
            signatureType: "Ológrafa", status: "Pagado", importe: 80000, hasAttachment: false, verPago: false
        });

        // --- 3. REGISTROS PARA RECHAZADOS ---
        mockRequests.push({
            id: "202600003", date: "08/01/2026 11:15:00", type: "Apostilla", country: "España", 
            institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento", 
            signatureType: "Electrónica", status: "Rechazado", hasAttachment: true, 
            reason: "Firma electrónica no validada."
        });
        mockRequests.push({
            id: "202600004", date: "08/01/2026 11:45:00", type: "Legalización", country: "Argentina", 
            institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento", 
            signatureType: "Ológrafa", status: "Rechazado", hasAttachment: false, 
            reason: "Sello no legible."
        });

        // --- 4. REGISTROS PARA DEVUELTOS ---
        mockRequests.push({
            id: "202600005", date: "08/01/2026 12:15:22", type: "Apostilla", country: "Paraguay",
            institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento",
            signatureType: "Electrónica", status: "Devuelto", hasAttachment: true,
            obs_text: "El campo 'Nombre del Padre' no coincide con el documento adjunto."
        });
        mockRequests.push({
            id: "202600006", date: "08/01/2026 12:45:10", type: "Legalización", country: "Uruguay",
            institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento",
            signatureType: "Ológrafa", status: "Devuelto", hasAttachment: false,
            obs_text: "Falta adjuntar el reverso del certificado."
        });

        // --- 5. APOSTILLA / FINALIZADOS (2 REGISTROS ESPECIFICOS) ---
        mockRequests.push({
            id: "202600007", date: "08/01/2026 08:30:15", type: "Apostilla", 
            country: "Paraguay", institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento", 
            status: "Finalizados", importe: 80100, hasAttachment: false, signatureType: "Electrónica"
        });
        mockRequests.push({
            id: "202600008", date: "08/01/2026 08:45:42", type: "Legalización", 
            country: "Paraguay", institution: "Registro del Estado Civil", doc: "Certificado de Nacimiento", 
            status: "Finalizados", importe: 80100, hasAttachment: false, signatureType: "Ológrafa"
        });

        let currentFilter = 'Devuelto', currentPage = 1, itemsPerPage = 10, selectedIds = new Set();

        function renderTable(status, page = 1) {
            currentFilter = status; currentPage = page;
            const tableHeader = document.getElementById('tableHeader');
            const tableContent = document.getElementById('tableContent');
            const pageDisplay = document.getElementById('pageIndicator'); // ID actualizado

            // Set Title based on Status
            const title = status === 'Finalizados' ? 'Apostilla' : `Solicitudes en ${status}`;
            document.getElementById('tableTitle').innerText = title;

            let tabColumns = [];
            if (status === 'Análisis') {
                tabColumns = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'status', 'download'];
            } else if (status === 'Aprobado') {
                tabColumns = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'status', 'importe', 'download', 'action'];
            } else if (status === 'Rechazado') {
                tabColumns = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'download', 'reason', 'action'];
            } else if (status === 'Devuelto') {
                tabColumns = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'download', 'obs', 'action'];
            } else if (status === 'Finalizados') { // APOSTILLA TAB LOGIC
                tabColumns = ['id', 'date', 'type', 'country', 'institution', 'doc', 'signatureType', 'adjunto', 'apostille_leg'];
            } else {
                tabColumns = ['id', 'doc', 'status', 'date'];
            }

            const visibleCols = columnsConfig.filter(c => tabColumns.includes(c.id) && c.visible);
            
            let headerHTML = visibleCols.map(c => `<th ${['action', 'download', 'adjunto', 'apostille_leg', 'importe', 'reason', 'obs'].includes(c.id) ? 'class="text-center"' : ''}>${c.label}</th>`).join('');
            if (status === 'Aprobado') headerHTML = `<th style="width: 40px;"></th>` + headerHTML;
            tableHeader.innerHTML = `<tr>${headerHTML}</tr>`;

            const filtered = mockRequests.filter(r => {
                if(status === 'Aprobado') return r.status === 'Aprobado' || r.status === 'Pagado';
                return r.status === status;
            });

            const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
            const pageData = filtered.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            document.getElementById('paginationInfo').innerText = `Mostrando ${filtered.length === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1} a ${Math.min(currentPage * itemsPerPage, filtered.length)} de ${filtered.length} registros`;
            
            // Actualizar botones de paginación
            document.getElementById('btnPageFirst').disabled = currentPage === 1;
            document.getElementById('btnPagePrev').disabled = currentPage === 1;
            document.getElementById('btnPageNext').disabled = currentPage === totalPages || filtered.length === 0;
            document.getElementById('btnPageLast').disabled = currentPage === totalPages || filtered.length === 0;
            
            // Actualizar indicador de página
            if(pageDisplay) pageDisplay.innerText = `Pág ${currentPage} de ${totalPages}`;

            tableContent.innerHTML = pageData.map(r => {
                let row = '';
                if(status === 'Aprobado') {
                    row += `<td>${r.status === 'Aprobado' ? `<input type="checkbox" onchange="toggleSelect('${r.id}', ${r.importe}, this)" ${selectedIds.has(r.id) ? 'checked' : ''}>` : ''}</td>`;
                }

                visibleCols.forEach(c => {
                    if(c.id === 'id') row += `<td><span class="fw-black text-navy">${r.id}</span></td>`;
                    if(c.id === 'date') row += `<td class="text-muted small fw-bold text-center">${r.date}</td>`;
                    if(c.id === 'type') row += `<td class="fw-bold">${r.type}</td>`;
                    if(c.id === 'country') row += `<td>${r.country}</td>`;
                    if(c.id === 'institution') row += `<td class="small fw-semibold">${r.institution}</td>`;
                    if(c.id === 'doc') row += `<td class="fw-bold text-navy">${r.doc}</td>`;
                    if(c.id === 'signatureType') row += `<td><span class="badge rounded-pill ${r.signatureType === 'Electrónica' ? 'bg-primary-subtle text-primary' : 'bg-secondary-subtle text-secondary'} p-2 px-3 fw-bold" style="font-size:0.65rem">${r.signatureType}</span></td>`;
                    if(c.id === 'status') {
                        let badgeClass = r.status === 'Pagado' ? 'bg-pagado' : (r.status === 'Análisis' ? 'bg-analisis' : (r.status === 'Aprobado' ? 'bg-success-subtle text-success' : (r.status === 'Devuelto' ? 'bg-devuelto' : '')));
                        row += `<td><span class="badge-status ${badgeClass}">${r.status}</span></td>`;
                    }
                    if(c.id === 'importe') {
                        row += `<td class="text-center fw-black text-primary">${r.importe > 0 ? `Gs. ${r.importe.toLocaleString('es-PY')}` : '-'}</td>`;
                    }
                    
                    // Columnas de descargas para otras pestañas
                    if(c.id === 'download') {
                        let showDownload = (r.signatureType === 'Electrónica');
                        row += `<td class="text-center">${showDownload ? `<i data-lucide="file-down" style="width:18px; cursor:pointer; color:var(--mre-blue)" title="Descargar documento"></i>` : `<span class="text-muted opacity-25">-</span>`}</td>`;
                    }

                    // Columnas específicas para Apostilla
                    if(c.id === 'adjunto') {
                        let showAdjunto = (r.signatureType === 'Electrónica');
                        row += `<td class="text-center">${showAdjunto ? `<i data-lucide="file-down" style="width:18px; cursor:pointer; color:var(--mre-blue)" title="Descargar Adjunto"></i>` : `<span class="text-muted opacity-25">-</span>`}</td>`;
                    }
                    if(c.id === 'apostille_leg') {
                        row += `<td class="text-center"><i data-lucide="file-down" style="width:18px; cursor:pointer; color:var(--mre-red)" title="Descargar PDF Apostilla/Legalización"></i></td>`;
                    }

                    if(c.id === 'reason') {
                        row += `<td class="text-center"><button class="btn-ver-motivo" onclick="showReason('${r.id}')">Ver</button></td>`;
                    }
                    if(c.id === 'obs') {
                        row += `<td class="text-center"><button class="btn-ver-obs" onclick="showDevueltoObs('${r.id}')">Ver</button></td>`;
                    }
                    if(c.id === 'action') {
                        if (status === 'Aprobado') {
                            row += `<td class="text-center">${r.status === 'Pagado' ? `<button class="btn-ver-pago" onclick="showPaymentInfo('${r.id}')">Ver Pago</button>` : `<span class="text-muted opacity-25">-</span>`}</td>`;
                        } else if (status === 'Rechazado') {
                            row += `<td class="text-center"><button class="btn-revision" onclick="showReview('${r.id}')">Revisión</button></td>`;
                        } else if (status === 'Devuelto') {
                            row += `<td class="text-center"><button class="btn-completar" onclick="completeRequest('${r.id}')">Completar</button></td>`;
                        }
                    }
                });
                return `<tr>${row}</tr>`;
            }).join('');
            
            document.getElementById('liquidadorSection').classList.toggle('hidden', status !== 'Aprobado');
            initColsMenu(status);
            lucide.createIcons();
        }

        // --- RESTAURADO: INFORMACIÓN DE PAGO DETALLADA ---
        function showPaymentInfo(id) {
            const popupTitle = document.getElementById('popupTitle');
            const popupContent = document.getElementById('popupContent');
            const popupActions = document.getElementById('popupActions');
            popupTitle.innerText = "Información del Pago";
            popupContent.innerHTML = `
                <div class="p-2">
                    <p class="mb-2"><strong>ID Transacción:</strong> TRX-7890${id}</p>
                    <p class="mb-2"><strong>Medio de Pago:</strong> Tarjeta de Crédito (Bancard)</p>
                    <p class="mb-2"><strong>Fecha de Pago:</strong> 08/01/2026 09:45:12</p>
                    <p class="mb-0 text-success fw-bold">El pago se encuentra validado y conciliado.</p>
                </div>
            `;
            popupActions.innerHTML = `<button class="btn-main w-100" onclick="closePopup()">Entendido</button>`;
            document.getElementById('genericPopup').style.display = 'flex';
        }

        function showReason(id) {
            const req = mockRequests.find(r => r.id === id);
            const popupTitle = document.getElementById('popupTitle');
            const popupContent = document.getElementById('popupContent');
            const popupActions = document.getElementById('popupActions');
            popupTitle.innerText = "Motivo de Rechazo";
            popupContent.innerHTML = `<div class="p-2"><div class="p-3 bg-danger-subtle rounded-3 text-danger">${req.reason}</div></div>`;
            popupActions.innerHTML = `<button class="btn-main w-100" onclick="closePopup()">Entendido</button>`;
            document.getElementById('genericPopup').style.display = 'flex';
        }

        function showDevueltoObs(id) {
            const req = mockRequests.find(r => r.id === id);
            const popupTitle = document.getElementById('popupTitle');
            const popupContent = document.getElementById('popupContent');
            const popupActions = document.getElementById('popupActions');
            popupTitle.innerText = "Observación de Devolución";
            popupContent.innerHTML = `<div class="p-2"><div class="p-3 bg-warning-subtle rounded-3 text-dark">${req.obs_text}</div></div>`;
            popupActions.innerHTML = `<button class="btn-main w-100" onclick="closePopup()">Entendido</button>`;
            document.getElementById('genericPopup').style.display = 'flex';
        }

        function completeRequest(id) { alert(`Redirigiendo a edición de #${id}...`); }

        function showReview(id) {
            const popupTitle = document.getElementById('popupTitle');
            const popupContent = document.getElementById('popupContent');
            const popupActions = document.getElementById('popupActions');
            popupTitle.innerText = "Solicitar Revisión";
            popupContent.innerHTML = `<div class="p-2"><textarea id="reviewObservation" class="form-control" rows="4" placeholder="Observaciones..."></textarea></div>`;
            popupActions.innerHTML = `<div class="d-flex gap-2"><button class="btn btn-light w-50 border" onclick="closePopup()">Cancelar</button><button class="btn-main w-50" id="btnConfirmReview">Confirmar</button></div>`;
            document.getElementById('btnConfirmReview').onclick = () => { closePopup(); alert("Enviado a revisión."); };
            document.getElementById('genericPopup').style.display = 'flex';
        }

        async function exportToPdf() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');
                doc.autoTable({ html: '#requestsTable' });
                doc.save(`SIA_PY_Reporte.pdf`);
            } catch (e) { window.print(); }
        }

        function exportToExcel() { alert("Exportando a Excel..."); }

        function navigateTo(view) {
            ['dashboardView', 'profileView', 'summaryView', 'newRequestView', 'validationView'].forEach(v => document.getElementById(v)?.classList.add('hidden'));
            document.getElementById(view + 'View')?.classList.remove('hidden');
            if(view === 'dashboard') renderTable(currentFilter);
            if(view === 'summary') buildSummary();
            // Reset form if navigating to newRequest
            if(view === 'newRequest') {
                tempRequestsList = []; // Limpiar lista al entrar de cero
                electronicSigCount = 0;
                renderLoadedDocuments();
                showRequestForm(); // Asegurar que se ve el formulario
            }
            lucide.createIcons();
            window.scrollTo(0, 0);
        }

        // Función para mostrar el formulario y ocultar la lista (Paso 1)
        function showRequestForm() {
            document.getElementById('newRequestForm').reset();
            handleSignatureChange();
            document.getElementById('additionalDataTabs').classList.add('hidden');
            showTab('titular-tab');
            
            document.getElementById('requestFormContainer').classList.remove('hidden');
            document.getElementById('loadedDocsSection').classList.add('hidden');
            lucide.createIcons();
        }

        // --- LÓGICA DE NUEVA SOLICITUD ---
        function handleSignatureChange() {
            const signature = document.getElementById('reqSignature').value;
            const attachmentField = document.getElementById('attachmentField');
            const docType = document.getElementById('reqDocType');
            const additionalTabs = document.getElementById('additionalDataTabs');

            // 1. Mostrar/Ocultar Adjunto
            if (signature === 'Electrónica') {
                attachmentField.classList.remove('hidden');
                // Hacer requerido el archivo si es electrónica
                document.getElementById('reqFile').required = true;
            } else {
                attachmentField.classList.add('hidden');
                document.getElementById('reqFile').required = false;
            }

            // 2. Habilitar/Deshabilitar Tipo de Documento
            if (signature && signature !== "") {
                docType.disabled = false;
                if (docType.options[0].text.includes('Seleccione primero')) {
                     docType.options[0].text = "Seleccione...";
                }
            } else {
                docType.disabled = true;
                docType.value = ""; // Reset value
                docType.options[0].text = "Seleccione primero el tipo de firma...";
                additionalTabs.classList.add('hidden'); // Ocultar pestañas si se resetea la firma
            }
            lucide.createIcons(); // Re-render icons if appearing
        }

        function handleDocTypeChange() {
            const docType = document.getElementById('reqDocType').value;
            const additionalTabs = document.getElementById('additionalDataTabs');
            if(docType) {
                additionalTabs.classList.remove('hidden');
                lucide.createIcons(); // Para iconos en el botón siguiente
            } else {
                additionalTabs.classList.add('hidden');
            }
        }

        // Función para cambiar de pestaña programáticamente
        function showTab(tabId) {
            const triggerEl = document.getElementById(tabId);
            if(triggerEl) {
                const tab = new bootstrap.Tab(triggerEl);
                tab.show();
            }
        }

        function populateYears() {
            const select = document.getElementById('actaYear');
            if(select) {
                const currentYear = new Date().getFullYear();
                for(let y = currentYear; y >= 1950; y--) {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.innerText = y;
                    select.appendChild(opt);
                }
            }
        }

        // --- LÓGICA DE GRILLA DE CARGA (BATCH) ---
        let tempRequestsList = [];
        let electronicSigCount = 0; // Contador para controlar la demo de validación

        function confirmAdd() {
            const signature = document.getElementById('reqSignature').value;
            const popupTitle = document.getElementById('popupTitle');
            const popupContent = document.getElementById('popupContent');
            const popupActions = document.getElementById('popupActions');

            let electronicMsg = '';
            if (signature === 'Electrónica') {
                electronicMsg = `
                    <div class="alert alert-primary mt-3 mb-0 small text-start border-primary-subtle">
                        <div class="d-flex gap-2">
                            <i data-lucide="scan-eye" style="width:16px; min-width:16px; margin-top:2px"></i>
                            <div><strong>Atención:</strong> Una vez confirmado, el sistema procederá a validar automáticamente la firma digital del documento adjunto.</div>
                        </div>
                    </div>`;
            }

            popupTitle.innerText = "Verificación de Datos";
            popupContent.innerHTML = `
                <div class="p-3 text-center">
                    <div class="mb-3 text-warning d-flex justify-content-center">
                        <i data-lucide="alert-circle" style="width:48px; height:48px"></i>
                    </div>
                    <p class="fw-bold mb-2">¿Son correctos los datos cargados?</p>
                    <p class="small text-muted">Confirmo que la información ha sido verificada uno por uno.</p>
                    ${electronicMsg}
                </div>
            `;
            
            popupActions.innerHTML = `
                <div class="d-flex gap-2">
                    <button class="btn btn-light w-50 border" onclick="closePopup()">Cancelar</button>
                    <button class="btn-main w-50" onclick="addToGrid()">Correcto</button>
                </div>
            `;
            
            document.getElementById('genericPopup').style.display = 'flex';
            lucide.createIcons();
        }

        function addToGrid() {
            closePopup(); // Cerrar el modal de confirmación

            // Generic fields
            const country = document.getElementById('reqCountry').value;
            const institution = document.getElementById('reqInstitution').value;
            const type = document.getElementById('reqType').value;
            const docType = document.getElementById('reqDocType').value;
            const signature = document.getElementById('reqSignature').value;
            const fileInput = document.getElementById('reqFile');
            const hasFile = signature === 'Electrónica' && fileInput.files.length > 0;

            // Titular fields
            const titularName = document.getElementById('titularName').value;
            const titularDocNum = document.getElementById('titularDocNum').value;
            
            // Specifics
            const actaNum = document.getElementById('actaNum').value;
            const actaYear = document.getElementById('actaYear').value;

            // Lógica de Validación Simulada (Determinista para Demo)
            let validationType = 'Previa'; // Default for Olograph
            let isValidated = null; // Null means N/A (for Olograph)

            if (signature === 'Electrónica') {
                electronicSigCount++; // Incrementar contador de firmas electrónicas
                let isSuccess;

                // Lógica específica solicitada:
                if (electronicSigCount === 1) {
                    isSuccess = true; // 1er registro: SI
                } else if (electronicSigCount === 2) {
                    isSuccess = false; // 2do registro: NO
                } else {
                    isSuccess = Math.random() > 0.3; // 3ro en adelante: Aleatorio
                }

                if (isSuccess) {
                    alert("✅ Documento validado correctamente.");
                    validationType = 'Automática';
                    isValidated = true;
                } else {
                    alert("⚠️ No se pudo validar automáticamente.\n\nLa solicitud cambiará a estado 'Validación Previa' para que sea analizada manualmente por un funcionario del MRE.");
                    validationType = 'Previa'; // Fallback a manual
                    isValidated = false;
                }
            }

            const newItem = {
                country,
                institution,
                type,
                docType,
                signature,
                hasFile,
                titularName,
                titularDocNum,
                actaNum,
                actaYear,
                validationType, 
                isValidated
            };

            tempRequestsList.push(newItem);
            renderLoadedDocuments();
            
            // OCULTAR FORMULARIO Y MOSTRAR LISTA
            document.getElementById('requestFormContainer').classList.add('hidden');
            document.getElementById('loadedDocsSection').classList.remove('hidden');
        }

        function renderLoadedDocuments() {
            const tbody = document.getElementById('loadedDocsBody');
            tbody.innerHTML = tempRequestsList.map((item, index) => {
                // Badge Tipo Validación
                let validationBadge = '';
                if (item.validationType === 'Automática') {
                    validationBadge = `<span class="badge bg-primary-subtle text-primary border border-primary-subtle" style="font-size: 0.65rem; text-transform: uppercase; font-weight: 700;">Automática</span>`;
                } else {
                    validationBadge = `<span class="badge bg-warning-subtle text-dark border border-warning-subtle" style="font-size: 0.65rem; text-transform: uppercase; font-weight: 700;">Validación Previa</span>`;
                }

                // Columna Validado (Si/No)
                let validatedStatus = '<span class="text-muted opacity-25">-</span>';
                if (item.signature === 'Electrónica') {
                    if (item.isValidated === true) {
                        validatedStatus = `<span class="badge bg-success text-white" style="font-size: 0.65rem;">SÍ</span>`;
                    } else if (item.isValidated === false) {
                        validatedStatus = `<span class="badge bg-danger text-white" style="font-size: 0.65rem;">NO</span>`;
                    }
                }

                return `
                <tr>
                    <td>${item.country}</td>
                    <td class="small fw-semibold">${item.institution}</td>
                    <td class="fw-bold text-navy">${item.docType}</td>
                    <td>${validationBadge}</td>
                    <td class="text-center">${validatedStatus}</td>
                    <td class="text-center">
                        ${item.hasFile ? `<i data-lucide="file-check" class="text-success" style="width:18px; cursor:pointer;" title="Descargar Adjunto"></i>` : `<span class="text-muted opacity-25">-</span>`}
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="removeFromGrid(${index})" title="Eliminar">
                            <i data-lucide="trash-2" style="width:18px;"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
            lucide.createIcons();
        }

        function removeFromGrid(index) {
            tempRequestsList.splice(index, 1);
            renderLoadedDocuments();
            if (tempRequestsList.length === 0) {
                document.getElementById('loadedDocsSection').classList.add('hidden');
            }
        }

        // Función llamada al presionar "Generar Solicitud" en la grilla de carga
        function submitFinalRequest() {
            if(tempRequestsList.length === 0) {
                alert("No hay documentos cargados.");
                return;
            }
            
            // 1. GENERAR IDS Y FECHAS (SIMULACIÓN DE GUARDADO EN BD)
            const now = new Date();
            const dateStr = now.toLocaleString('es-PY');
            const generatedBatch = tempRequestsList.map((item, index) => {
                const newId = `2026-${String(Math.floor(Math.random() * 100000)).padStart(5, '0')}`;
                return {
                    ...item,
                    id: newId,
                    date: dateStr,
                    status: item.validationType === 'Automática' ? 'Aprobado' : 'Análisis',
                    importe: 80100 // Arancel fijo
                };
            });

            // Guardar en la "base de datos" mock
            generatedBatch.forEach(req => {
                mockRequests.push({
                    id: req.id,
                    date: req.date,
                    type: req.type,
                    country: req.country,
                    institution: req.institution,
                    doc: req.docType,
                    signatureType: req.signature,
                    status: req.status,
                    importe: req.importe,
                    hasAttachment: req.hasFile,
                    titularName: req.titularName
                });
            });

            // Separar listas
            const autoList = generatedBatch.filter(i => i.validationType === 'Automática');
            const manualList = generatedBatch.filter(i => i.validationType === 'Previa');
            
            let htmlContent = '';
            let initialTotal = 0;

            // 1. SECCIÓN VALIDACIÓN AUTOMÁTICA (CON CHECKBOXES Y TOTAL EN BOTÓN)
            if (autoList.length > 0) {
                const autoRows = autoList.map(item => {
                    initialTotal += item.importe;
                    return `
                    <tr>
                        <td class="p-3 text-center">
                            <input type="checkbox" class="form-check-input auto-check" value="${item.id}" data-amount="${item.importe}" checked onchange="updateLiquidationButton()">
                        </td>
                        <td class="p-3 fw-black text-navy">${item.id}</td>
                        <td class="p-3 small text-muted">${item.date}</td>
                        <td class="p-3"><span class="badge bg-light text-dark border">${item.signature}</span></td>
                        <td class="p-3 fw-bold">${item.docType}</td>
                        <td class="p-3 text-uppercase small fw-bold">${item.titularName}</td>
                        <td class="p-3 text-end fw-black text-primary">Gs. ${item.importe.toLocaleString('es-PY')}</td>
                    </tr>
                    `;
                }).join('');

                // DISEÑO ACTUALIZADO: Estructura idéntica al bloque manual
                htmlContent += `
                    <div class="mb-5 animate-fade bg-white border rounded-3 shadow-sm overflow-hidden">
                        <div class="p-3 bg-primary-subtle border-bottom border-primary-subtle d-flex justify-content-between align-items-center">
                            <h6 class="fw-black text-primary m-0 d-flex align-items-center gap-2">
                                <i data-lucide="zap" style="width:18px"></i> Verificación Automática
                            </h6>
                            <span class="badge bg-white text-primary border">Listo para Pago</span>
                        </div>
                        <div class="p-3 bg-light border-bottom small text-muted">
                            <i data-lucide="info" style="width:14px; margin-bottom:2px" class="me-1"></i>
                            Puede proceder al pago de las solicitudes verificadas automaticamente o puede pagar desde la bandeja de solicitudes aprobadas
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" style="font-size: 0.85rem;">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="p-3 text-center" style="width: 40px;">
                                            <input type="checkbox" class="form-check-input" id="checkAllAuto" checked onchange="toggleAllAuto(this)">
                                        </th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase">Nro. Solicitud</th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase">Fecha Generación</th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase">Tipo Firma</th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase">Documento</th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase">Titular</th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase text-end">Importe</th>
                                    </tr>
                                </thead>
                                <tbody>${autoRows}</tbody>
                            </table>
                        </div>
                        <div class="p-3 bg-light border-top d-flex justify-content-end">
                            <button id="btnGenLiq" class="btn-main px-4 py-2 d-flex align-items-center gap-2" onclick="goToLiquidationSelected()">
                                <i data-lucide="receipt" style="width:18px"></i> Generar Liquidación (Gs. ${initialTotal.toLocaleString('es-PY')})
                            </button>
                        </div>
                    </div>
                `;
            }

            // 2. SECCIÓN VALIDACIÓN MANUAL / PREVIA
            if (manualList.length > 0) {
                const manualRows = manualList.map(item => {
                    let legend = '';
                    let legendStyle = '';
                    let icon = '';

                    if (item.signature === 'Electrónica') {
                        // Lógica: Electrónica pero cayó en manual (no validada)
                        icon = 'file-clock';
                        legendStyle = 'background-color: #fff8c5; color: #664d03; border: 1px solid #ffecb5;'; // Estilo warning suave
                        legend = 'La solicitud requiere análisis manual. Se le notificará cuando cambien de estado o puede consultar el estado desde su sistema de gestión.';
                    } else {
                        // Lógica: Ológrafa
                        icon = 'map-pin';
                        legendStyle = 'background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7;'; // Estilo danger suave
                        legend = 'La solicitud requiere presentación física en el local MRE para validación del documento.';
                    }

                    return `
                    <tr>
                        <td class="p-3 fw-black text-dark">${item.id}</td>
                        <td class="p-3 small text-muted">${item.date}</td>
                        <td class="p-3"><span class="badge bg-light text-dark border">${item.signature}</span></td>
                        <td class="p-3">
                            <div class="fw-bold mb-2">${item.docType}</div>
                            <div class="small p-2 rounded d-flex gap-2 align-items-start" style="${legendStyle}">
                                <i data-lucide="${icon}" style="width:16px; min-width:16px; margin-top:2px;"></i>
                                <span>${legend}</span>
                            </div>
                        </td>
                        <td class="p-3 text-uppercase small fw-bold">${item.titularName}</td>
                    </tr>
                    `;
                }).join('');

                htmlContent += `
                    <div class="mb-4 animate-fade bg-white border rounded-3 shadow-sm overflow-hidden" style="animation-delay: 0.1s">
                        <div class="p-3 bg-warning-subtle border-bottom border-warning-subtle d-flex justify-content-between align-items-center">
                            <h6 class="fw-black text-dark m-0 d-flex align-items-center gap-2">
                                <i data-lucide="clock" style="width:18px"></i> Verificación Previa Requerida
                            </h6>
                            <span class="badge bg-white text-dark border">En Análisis / Pendiente</span>
                        </div>
                        <!-- Mensaje genérico eliminado, ahora es específico por fila -->
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" style="font-size: 0.85rem;">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="p-3 text-muted small fw-bold text-uppercase">Nro. Solicitud</th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase">Fecha Generación</th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase">Tipo Firma</th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase" style="min-width: 300px;">Documento / Instrucciones</th>
                                        <th class="p-3 text-muted small fw-bold text-uppercase">Titular</th>
                                    </tr>
                                </thead>
                                <tbody>${manualRows}</tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            document.getElementById('validationTablesContainer').innerHTML = htmlContent;
            navigateTo('validation'); // Ir a pantalla "Solicitudes Generadas"
            lucide.createIcons();
        }

        // --- FUNCIONES PARA LA SELECCIÓN DE PAGOS ---
        function toggleAllAuto(source) {
            const checkboxes = document.querySelectorAll('.auto-check');
            checkboxes.forEach(cb => cb.checked = source.checked);
            updateLiquidationButton();
        }

        function updateLiquidationButton() {
            const checkboxes = document.querySelectorAll('.auto-check:checked');
            let total = 0;
            checkboxes.forEach(cb => {
                total += parseInt(cb.dataset.amount || 0);
            });
            
            const btn = document.getElementById('btnGenLiq');
            if(btn) {
                btn.innerHTML = `<i data-lucide="receipt" style="width:18px"></i> Generar Liquidación (Gs. ${total.toLocaleString('es-PY')})`;
                btn.disabled = total === 0;
                lucide.createIcons();
            }
        }

        function goToLiquidationSelected() {
            const checkboxes = document.querySelectorAll('.auto-check:checked');
            const idsArray = Array.from(checkboxes).map(cb => cb.value);
            
            if(idsArray.length === 0) {
                alert("Seleccione al menos una solicitud para pagar.");
                return;
            }
            
            selectedIds = new Set(idsArray); 
            navigateTo('summary');
        }

        function resetAndGoHome() {
             closePopup(); 
             tempRequestsList=[]; 
             electronicSigCount=0; 
             renderLoadedDocuments(); 
             document.getElementById('loadedDocsSection').classList.add('hidden'); 
             navigateTo('dashboard');
        }

        // --- RESTAURADO: GENERACIÓN DE LIQUIDACIÓN COMPLETA ---
        function buildSummary() {
            const list = document.getElementById('summaryItemsList');
            const totalDisplay = document.getElementById('summaryTotalValue');
            const requestDate = document.getElementById('summaryRequestDate');
            const expiryDate = document.getElementById('summaryExpiryDate');
            
            let total = 0, html = '';
            selectedIds.forEach(id => {
                const req = mockRequests.find(r => r.id === id);
                if (req) {
                    total += req.importe;
                    html += `
                        <div class="summary-item">
                            <div>
                                <p class="fw-black text-navy mb-0 small">#${req.id} - ${req.doc}</p>
                                <p class="extra-small text-muted mb-0">Arancel Ley 6351/19</p>
                            </div>
                            <span class="fw-black text-navy">Gs. ${req.importe.toLocaleString('es-PY')}</span>
                        </div>`;
                }
            });
            
            list.innerHTML = html;
            totalDisplay.innerText = `Gs. ${total.toLocaleString('es-PY')}`;
            
            // Lógica de fechas
            const now = new Date();
            const exp = new Date(now.getTime() + (48 * 60 * 60 * 1000));
            requestDate.innerText = now.toLocaleString('es-PY');
            expiryDate.innerText = exp.toLocaleString('es-PY');
        }

        function toggleUserMenu(e) { e.stopPropagation(); document.getElementById('userMenu').classList.toggle('show'); }
        document.addEventListener('click', () => {
            ['userMenu', 'a11yMenu', 'colsMenu'].forEach(m => document.getElementById(m)?.classList.remove('show'));
        });

        function handleLogout() { location.reload(); }
        function filterTable(status, el) {
            document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            renderTable(status, 1);
        }

        function searchRequests(input) {
            const val = input.value.toLowerCase();
            document.querySelectorAll('#tableContent tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(val) ? '' : 'none'; });
        }
        
        function changePage(action) {
            const filtered = mockRequests.filter(r => {
                if(currentFilter === 'Aprobado') return r.status === 'Aprobado' || r.status === 'Pagado';
                return r.status === currentFilter;
            });
            const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;

            if (action === 'first') currentPage = 1;
            else if (action === 'prev' && currentPage > 1) currentPage--;
            else if (action === 'next' && currentPage < totalPages) currentPage++;
            else if (action === 'last') currentPage = totalPages;

            renderTable(currentFilter, currentPage);
        }

        function toggleSelect(id, importe, cb) {
            if (cb.checked) selectedIds.add(id); else selectedIds.delete(id);
            const total = [...selectedIds].reduce((acc, id) => acc + (mockRequests.find(r => r.id === id)?.importe || 0), 0);
            document.getElementById('btnLiquidacion').innerText = `Generar Liquidación (Gs. ${total.toLocaleString('es-PY')})`;
            document.getElementById('btnLiquidacion').disabled = selectedIds.size === 0;
        }

        function closePopup() { document.getElementById('genericPopup').style.display = 'none'; }
        
        // --- FUNCIONES PERFIL ---
        function saveProfile() {
            // Mock saving logic
            const name = document.getElementById('profileName').value;
            const surname = document.getElementById('profileSurname').value;
            
            // Update header name mock
            const headerName = document.querySelector('.header-profile-trigger .small.fw-black');
            if(headerName) headerName.innerText = `${name} ${surname}`.toUpperCase();
            
            const dropdownName = document.querySelector('.dropdown-header-info .fw-black');
            if(dropdownName) dropdownName.innerText = `${name} ${surname}`;

            // Show success message
            const popupTitle = document.getElementById('popupTitle');
            const popupContent = document.getElementById('popupContent');
            const popupActions = document.getElementById('popupActions');
            
            popupTitle.innerText = "Perfil Actualizado";
            popupContent.innerHTML = `
                <div class="text-center p-3">
                    <div class="text-success mb-2 d-flex justify-content-center"><i data-lucide="check-circle" style="width:48px; height:48px"></i></div>
                    <p class="fw-bold mb-0">Sus datos han sido guardados correctamente.</p>
                </div>
            `;
            popupActions.innerHTML = `<button class="btn-main w-100" onclick="closePopup(); navigateTo('dashboard')">Aceptar</button>`;
            document.getElementById('genericPopup').style.display = 'flex';
            lucide.createIcons();
        }

        function requestPasswordReset() {
            const email = "juan.perez@email.com";
            const popupTitle = document.getElementById('popupTitle');
            const popupContent = document.getElementById('popupContent');
            const popupActions = document.getElementById('popupActions');
            
            popupTitle.innerText = "Cambio de Contraseña";
            popupContent.innerHTML = `
                <div class="p-3">
                    <p>Se ha enviado un enlace de confirmación a <strong>${email}</strong>.</p>
                    <p class="small text-muted mb-0">Por favor, verifique su bandeja de entrada para continuar con el proceso de cambio de contraseña.</p>
                </div>
            `;
            popupActions.innerHTML = `<button class="btn-main w-100" onclick="closePopup()">Entendido</button>`;
            document.getElementById('genericPopup').style.display = 'flex';
        }

        // --- FUNCION DE SCROLL HORIZONTAL ---
        function scrollStatus(direction) {
            const container = document.getElementById('statusScrollContainer');
            const scrollAmount = 200; // Cantidad de px a desplazar
            if (direction === 'left') {
                container.scrollLeft -= scrollAmount;
            } else {
                container.scrollLeft += scrollAmount;
            }
        }
    </script>
</body>
</html>
